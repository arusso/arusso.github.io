<!doctype html><html lang=en-us><head><link rel=icon href=/favicon_main.svg><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><meta property="og:url" content="https://arusso.io/posts/inexpensive_puppet_manifest_testing/"><meta property="og:type" content="article"><meta property="og:title" content="Inexpensive Puppet Manifest Testing"><meta property="og:description" content="Dead simple Puppet testing with shell and SSH that you probably should avoid.
"><meta property="og:image:width" content="375"><meta property="og:image:height" content="250"><meta property="og:image" content="https://arusso.io/images/default_summary_hu2be732aee21a2469ead3fe1f2df8caca_2088687_600x0_resize_q75_box.jpg"><title>Personal website and blog - Inexpensive Puppet Manifest Testing</title><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link rel=stylesheet type=text/css href=/css/style.6fd7fa42c7b7fe49cfeceeed650d33cb8d1cdbfe842e514a22e57a6b712729aa.css integrity="sha256-b9f6Qse3/knP7O7tZQ0zy40c2/6ELlFKIuV6a3EnKao="><link rel=stylesheet type=text/css href=/css/monokai-sublime.9.15.8.min.91376415864fdd3a92be524052267afece4bdb1bb8c6c754f5e60c5ac28e93be.css integrity="sha256-kTdkFYZP3TqSvlJAUiZ6/s5L2xu4xsdU9eYMWsKOk74="><link rel=stylesheet type=text/css href=/css/all.min.2d91c07e15fc26f2697117b326256c0a2b0586dd12a15c622a53cd47a9e54a1d.css integrity="sha256-LZHAfhX8JvJpcRezJiVsCisFht0SoVxiKlPNR6nlSh0="><link rel=stylesheet type=text/css href=/css/refresh.ccfd23f8053a1571a3e474a6877f42a6a1924c6bbf1b64c7704b49a0353b4650.css integrity="sha256-zP0j+AU6FXGj5HSmh39CpqGSTGu/G2THcEtJoDU7RlA="><link rel=stylesheet type=text/css href=/css/devicon.min.149016fbf45c8bc157d6f55ce3ee875feaa3f90446bf7d151fbc16a9f21a8859.css integrity="sha256-FJAW+/Rci8FX1vVc4+6HX+qj+QRGv30VH7wWqfIaiFk="></head><body><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26798644-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-26798644-1')</script><div id=preloader><div id=status></div></div><nav class="navbar is-fresh is-transparent no-shadow" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item><div class="menu-icon-wrapper left-menu-icon-wrapper" style=visibility:visible><svg width="1e3" height="1e3"><path class="path1" d="M3e2 4e2H7e2c2e2.0 2e2 350-1e2 450A4e2 4e2.0 012e2 2e2L8e2 8e2"/><path class="path2" d="M3e2 5e2H7e2"/><path class="path3" d="M7e2 6e2H3e2c-2e2.0-2e2-4e2 1e2-450A4e2 380 0 112e2 8e2L8e2 2e2"/></svg><button id=menu-icon-trigger class=menu-icon-trigger></button></div><div class="navbar-item left-menu-icon-wrapper">Tags</div></a><div class="navbar-item is-expanded"></div><a class="navbar-item is-hidden-desktop"><div data-target=navbar-menu class="navbar-item right-menu-icon-wrapper is-hidden-desktop">Menu</div><div data-target=navbar-menu class="menu-icon-wrapper right-menu-icon-wrapper" style=visibility:visible><svg width="1e3" height="1e3"><path class="path1" d="M3e2 4e2H7e2c2e2.0 2e2 350-1e2 450A4e2 4e2.0 012e2 2e2L8e2 8e2"/><path class="path2" d="M3e2 5e2H7e2"/><path class="path3" d="M7e2 6e2H3e2c-2e2.0-2e2-4e2 1e2-450A4e2 380 0 112e2 8e2L8e2 2e2"/></svg><button id=menu-icon-trigger class=menu-icon-trigger></button></div></a></div><div id=navbar-menu class="navbar-menu is-static"><div class=navbar-end><a href=/ class="navbar-item is-secondary">Homepage</a><a href=/about/ class="navbar-item is-secondary">About Me</a><a href=/posts/ class="navbar-item is-secondary">Posts</a></div></div></div></nav><nav id=navbar-clone class="navbar is-fresh is-transparent" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item><div class="menu-icon-wrapper left-menu-icon-wrapper" style=visibility:visible><svg width="1e3" height="1e3"><path class="path1" d="M3e2 4e2H7e2c2e2.0 2e2 350-1e2 450A4e2 4e2.0 012e2 2e2L8e2 8e2"/><path class="path2" d="M3e2 5e2H7e2"/><path class="path3" d="M7e2 6e2H3e2c-2e2.0-2e2-4e2 1e2-450A4e2 380 0 112e2 8e2L8e2 2e2"/></svg><button id=menu-icon-trigger class=menu-icon-trigger></button></div><div class="navbar-item left-menu-icon-wrapper">Tags</div></a><div class="navbar-item is-expanded"></div><a class="navbar-item is-hidden-desktop"><div data-target=cloned-navbar-menu class="navbar-item right-menu-icon-wrapper is-hidden-desktop">Menu</div><div data-target=cloned-navbar-menu class="menu-icon-wrapper right-menu-icon-wrapper" style=visibility:visible><svg width="1e3" height="1e3"><path class="path1" d="M3e2 4e2H7e2c2e2.0 2e2 350-1e2 450A4e2 4e2.0 012e2 2e2L8e2 8e2"/><path class="path2" d="M3e2 5e2H7e2"/><path class="path3" d="M7e2 6e2H3e2c-2e2.0-2e2-4e2 1e2-450A4e2 380 0 112e2 8e2L8e2 2e2"/></svg><button id=menu-icon-trigger class=menu-icon-trigger></button></div></a></div><div id=cloned-navbar-menu class="navbar-menu is-static"><div class=navbar-end><a href=/ class="navbar-item is-secondary">Homepage</a><a href=/about/ class="navbar-item is-secondary">About Me</a><a href=/posts/ class="navbar-item is-secondary">Posts</a></div></div></div></nav><section class="section is-medium"><div class=container><div class=columns><div class="column is-centered-tablet-portrait"><h1 class="title is-2 section-title">Inexpensive Puppet Manifest Testing</h1><h5 class="subtitle is-5 is-muted"></h5><div class=divider></div><section class="section content has-text-justified"><p><em>&mldr;because &ldquo;Poor Man&rsquo;s Puppet Testing&rdquo; just sounded lame&mldr;</em></p><h2 id=disclaimer>Disclaimer</h2><p>There are better, more effective and automated ways of testing your puppet
manifests. However if you are in a position where setting up a CI server is not
in the time budget, this article is for you.</p><p>This article also assumes you do not have some sort of orchestration tool at
your disposal, and uses SSH<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> to fake it until we make it. If this is not your
situation fret not! You should be able to tailor it to use your orchestration
tool of choice with minimal effort.</p><h2 id=overview>Overview</h2><p>This article discusses a fairly simple idea &ndash; we will be updating some puppet
code, committing our changes and having a simple process run noop runs on hosts
we specify. The output of these runs will be displayed for us to inspect.</p><h2 id=setup>Setup</h2><p>First off, we will need two bash functions. The first is a helper function that
I came up with as a way to abstract away running arbirtray commands on a host
called <code>runon</code>. Fancy, right? Fortunately, you should be able to refactor it
to use your tool of choice fairly easily.</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-bash">runon () {
    CLIENT=$1;
    COMMAND=$2;
    SSH_OPTS=&#34;-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -a -T&#34;

    if [[ &#34;$1&#34; == &#34;&#34; || &#34;$2&#34; == &#34;&#34; ]]; then
        echo &#34;USAGE: runon &lt;client&gt; \&#34;&lt;command&gt;\&#34;    &#34;;
    else
        ssh $SSH_OPTS ${CLIENT} &#34;$2&#34;;
    fi
}</code></pre></div></div><p>Next up, we are going to setup a bash function that is constantly checking a
file we specify for hosts to connect and test our manifests against. I use
environments to test all code changes<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, so the function needs to know about
the environment as well as the filename to poll for changes.</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-bash">test_puppet_env () {
    if [[ -f $1 &amp;&amp; &#34;$2&#34; != &#34;&#34; ]]; then
        while [ 1 -eq 1 ]; do
            while read line; do
                for hst in $(eval &#34;echo $line&#34;); do
                    echo &#34;#### HOST: ${hst} ####&#34;;
                    runon ${hst} &#34;sudo puppet agent -t --noop --environment ${2}&#34;;
                    echo &#34;#######################&#34;;
                done;
                eval &#34;sed -i &#39;&#39; -e &#39;/^$line\$/d&#39;&#34; $1;
            done &lt; $1;
            sleep 1;
        done
    else
       echo &#34;USAGE: test_puppet_env &lt;filename&gt; &lt;environment&gt;&#34;
       return
    fi
}</code></pre></div></div><p>With that, we have all the functions we need. Now, let&rsquo;s put it to use. We will
assume I am doing some refactoring in a puppet environment &lsquo;foo&rsquo;, and want to
test changes that would apply to hosts specified in ~/test-hosts</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-bash">test_puppet_env ~/test-hosts foo</code></pre></div></div><p>Now open up a new window (or hopefully a pane<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>) and run the following command:</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-bash">echo arusso-dev-0{1..9}.example.com &gt;&gt; ~/test-hosts</code></pre></div></div><p>Suddenly, you will see output in the original pane where we ran
<code>test_puppet_env</code>. For a couple of hosts, this works reasonably well. But
when I am testing a large number of hosts (>5) I typically do the following so
I can grep through the files later rather than read them outright:</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-bash">test_puppet_env ~/test-hosts foo | tee session-$(date &#43;%Y%m%dT%H%M)</code></pre></div></div><p>Now, in addition to having the output sent to stdout I can have a file I can
grep/awk/sed through to find interesting bits of information I&rsquo;m looking for.</p><p>So that&rsquo;s it. Not too bad, right? Let me know what you think below.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Technically this is SSH in a loop. Sleep well knowing I carry the burden of this terrible deed. Still, let&rsquo;s keep it between us and not say anything to Luke.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Obviously some code cannot be tested in environments; the most obvious example being types. I assume that you know this, and use something like Vagrant to develop and modify such code in a sandbox. If not, I highly suggest this approach.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>tmux (or screen) is your friend here.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section></div></div></div><div class=container><div class=columns><div class="column has-text-right is-family-monospace is-centered-tablet-portrait">Last modified:&nbsp;18 April 2015</div></div></div></section><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//brainctl.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div id=backtotop><a href=#></a></div><div class="sidebar scroll"><div class=sidebar-header><img src=/sidebar.svg alt>
<a class=sidebar-close href=javascript:void(0);><i data-feather=x></i></a></div><div class=inner><ul class=sidebar-menu><li class=no-children><a href=/tags/><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cubes"></i></span>
All Tags</td><td class=has-text-right></td></tr></table></div></a><li class=no-children><a href=/tags/networking><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>networking</td><td class=has-text-right><div class=tag-number>2</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/puppet><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>puppet</td><td class=has-text-right><div class=tag-number>2</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ruby><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ruby</td><td class=has-text-right><div class=tag-number>2</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/bash><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>bash</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/certificate><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>certificate</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ci><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ci</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/cni><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>cni</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ex2300><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ex2300</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ex3400><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ex3400</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ipv6><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ipv6</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/juniper><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>Juniper</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/junos><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>JunOS</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/nmcli><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>nmcli</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/openssl><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>openssl</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/podman><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>podman</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/rbenv><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>rbenv</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/rfc4941><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>rfc4941</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/rfc7217><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>rfc7217</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/rvm><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>rvm</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/san><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>san</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ssl/tls><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ssl/tls</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/testing><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>testing</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li></ul></div></div><script src=/js/jquery-2.2.4.893e90f6230962e42231635df650f20544ad22affc3ee396df768eaa6bc5a6a2.js integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI="></script>
<script src=/js/feather.4.22.0.1ab07abeb9975f283f6b5f29451981be680fbf77ea778f991d457511d210476a.js integrity="sha256-GrB6vrmXXyg/a18pRRmBvmgPv3fqd4+ZHUV1EdIQR2o="></script>
<script src=/js/modernizr-3.6.0.e013a1e54e3c19d83537ba42b900d34451e5e4b2e789be27a02ac9b152edb741.js integrity="sha256-4BOh5U48Gdg1N7pCuQDTRFHl5LLnib4noCrJsVLtt0E="></script>
<script src=/js/refresh.62c1a9b7d85bcf4d944cd585a01dfa8fb15112a7d2cf9fb819db20493bfe7484.js integrity="sha256-YsGpt9hbz02UTNWFoB36j7FREqfSz5+4GdsgSTv+dIQ="></script><script>window.MathJax={loader:{load:['core','input/tex-base','output/chtml'],source:{core:'/js/mathjax/core.d48fedf25c74c54fa6bf79646de92b02155872bdc4f5f7d0bbfc662523d8b4f5.js','input/tex-base':'/js/mathjax/tex-base.1b68b8741dfc54e8f7222f88bea8ffcfc57ac54b2a2d8f4edf6800aa44d49441.js','output/chtml':'/js/mathjax/chtml.926cd166e0f8c1f8a566a718d60c9c58a2b7142b156d30d5f02cec7c3b0ad60a.js','output/chtml/fonts/tex':'/js/mathjax/tex_out.b8b2bb939c0dae84bf1390bfe6d32af13e83f647cdac01d544d2a7a517477e9d.js'}},chtml:{fontURL:'/fonts'}}</script><script src=/js/mathjax/startup.234a2513e6bdbc1eee06ca19abceca30fe4034e82afb373c08274c1ba2feb1a6.js integrity="sha256-I0olE+a9vB7uBsoZq87KMP5ANOgq+zc8CCdMG6L+saY="></script>
<script src=/js/highlight.9.18.1.b1c58829c55afcc1f568022af4b08ed8976da404d2990b7535bd8e19c0e3310c.js integrity="sha256-scWIKcVa/MH1aAIq9LCO2JdtpATSmQt1Nb2OGcDjMQw="></script>
<script src=/js/highlightjs-line-numbers.2.7.0.min.ddfe282e07b7ec1ed069c23f92c7c8216ddb3f1879c4e962d37fd52adbd15a05.js integrity="sha256-3f4oLge37B7QacI/ksfIIW3bPxh5xOli03/VKtvRWgU="></script><script>hljs.initHighlightingOnLoad(),hljs.initLineNumbersOnLoad(),document.addEventListener('DOMContentLoaded',e=>{document.querySelectorAll('.codeinline').forEach(e=>{hljs.highlightBlock(e)})})</script></body></html>