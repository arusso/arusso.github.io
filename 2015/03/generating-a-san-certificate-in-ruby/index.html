<!doctype html><html lang=en-us><head><link rel=icon href=/favicon_main.svg><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><meta property="og:url" content="https://arusso.io/2015/03/generating-a-san-certificate-in-ruby/"><meta property="og:type" content="article"><meta property="og:title" content="Generating a SAN Certificate in Ruby"><meta property="og:description" content="Generating SAN certificates using Ruby's OpenSSL library"><meta property="og:image:width" content="375"><meta property="og:image:height" content="250"><meta property="og:image" content="https://arusso.io/images/default_summary_hu2be732aee21a2469ead3fe1f2df8caca_2088687_600x0_resize_q75_box.jpg"><title>Personal website and blog - Generating a SAN Certificate in Ruby</title><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link rel=stylesheet type=text/css href=/css/style.6fd7fa42c7b7fe49cfeceeed650d33cb8d1cdbfe842e514a22e57a6b712729aa.css integrity="sha256-b9f6Qse3/knP7O7tZQ0zy40c2/6ELlFKIuV6a3EnKao="><link rel=stylesheet type=text/css href=/css/monokai-sublime.9.15.8.min.91376415864fdd3a92be524052267afece4bdb1bb8c6c754f5e60c5ac28e93be.css integrity="sha256-kTdkFYZP3TqSvlJAUiZ6/s5L2xu4xsdU9eYMWsKOk74="><link rel=stylesheet type=text/css href=/css/all.min.2d91c07e15fc26f2697117b326256c0a2b0586dd12a15c622a53cd47a9e54a1d.css integrity="sha256-LZHAfhX8JvJpcRezJiVsCisFht0SoVxiKlPNR6nlSh0="><link rel=stylesheet type=text/css href=/css/refresh.ccfd23f8053a1571a3e474a6877f42a6a1924c6bbf1b64c7704b49a0353b4650.css integrity="sha256-zP0j+AU6FXGj5HSmh39CpqGSTGu/G2THcEtJoDU7RlA="><link rel=stylesheet type=text/css href=/css/devicon.min.149016fbf45c8bc157d6f55ce3ee875feaa3f90446bf7d151fbc16a9f21a8859.css integrity="sha256-FJAW+/Rci8FX1vVc4+6HX+qj+QRGv30VH7wWqfIaiFk="></head><body><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26798644-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-26798644-1')</script><div id=preloader><div id=status></div></div><nav class="navbar is-fresh is-transparent no-shadow" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item><div class="menu-icon-wrapper left-menu-icon-wrapper" style=visibility:visible><svg width="1e3" height="1e3"><path class="path1" d="M3e2 4e2H7e2c2e2.0 2e2 350-1e2 450A4e2 4e2.0 012e2 2e2L8e2 8e2"/><path class="path2" d="M3e2 5e2H7e2"/><path class="path3" d="M7e2 6e2H3e2c-2e2.0-2e2-4e2 1e2-450A4e2 380 0 112e2 8e2L8e2 2e2"/></svg><button id=menu-icon-trigger class=menu-icon-trigger></button></div><div class="navbar-item left-menu-icon-wrapper">Tags</div></a><div class="navbar-item is-expanded"></div><a class="navbar-item is-hidden-desktop"><div data-target=navbar-menu class="navbar-item right-menu-icon-wrapper is-hidden-desktop">Menu</div><div data-target=navbar-menu class="menu-icon-wrapper right-menu-icon-wrapper" style=visibility:visible><svg width="1e3" height="1e3"><path class="path1" d="M3e2 4e2H7e2c2e2.0 2e2 350-1e2 450A4e2 4e2.0 012e2 2e2L8e2 8e2"/><path class="path2" d="M3e2 5e2H7e2"/><path class="path3" d="M7e2 6e2H3e2c-2e2.0-2e2-4e2 1e2-450A4e2 380 0 112e2 8e2L8e2 2e2"/></svg><button id=menu-icon-trigger class=menu-icon-trigger></button></div></a></div><div id=navbar-menu class="navbar-menu is-static"><div class=navbar-end><a href=/ class="navbar-item is-secondary">Homepage</a><a href=/about/ class="navbar-item is-secondary">About Me</a><a href=/posts/ class="navbar-item is-secondary">Posts</a></div></div></div></nav><nav id=navbar-clone class="navbar is-fresh is-transparent" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item><div class="menu-icon-wrapper left-menu-icon-wrapper" style=visibility:visible><svg width="1e3" height="1e3"><path class="path1" d="M3e2 4e2H7e2c2e2.0 2e2 350-1e2 450A4e2 4e2.0 012e2 2e2L8e2 8e2"/><path class="path2" d="M3e2 5e2H7e2"/><path class="path3" d="M7e2 6e2H3e2c-2e2.0-2e2-4e2 1e2-450A4e2 380 0 112e2 8e2L8e2 2e2"/></svg><button id=menu-icon-trigger class=menu-icon-trigger></button></div><div class="navbar-item left-menu-icon-wrapper">Tags</div></a><div class="navbar-item is-expanded"></div><a class="navbar-item is-hidden-desktop"><div data-target=cloned-navbar-menu class="navbar-item right-menu-icon-wrapper is-hidden-desktop">Menu</div><div data-target=cloned-navbar-menu class="menu-icon-wrapper right-menu-icon-wrapper" style=visibility:visible><svg width="1e3" height="1e3"><path class="path1" d="M3e2 4e2H7e2c2e2.0 2e2 350-1e2 450A4e2 4e2.0 012e2 2e2L8e2 8e2"/><path class="path2" d="M3e2 5e2H7e2"/><path class="path3" d="M7e2 6e2H3e2c-2e2.0-2e2-4e2 1e2-450A4e2 380 0 112e2 8e2L8e2 2e2"/></svg><button id=menu-icon-trigger class=menu-icon-trigger></button></div></a></div><div id=cloned-navbar-menu class="navbar-menu is-static"><div class=navbar-end><a href=/ class="navbar-item is-secondary">Homepage</a><a href=/about/ class="navbar-item is-secondary">About Me</a><a href=/posts/ class="navbar-item is-secondary">Posts</a></div></div></div></nav><section class="section is-medium"><div class=container><div class=columns><div class="column is-centered-tablet-portrait"><h1 class="title is-2 section-title">Generating a SAN Certificate in Ruby</h1><h5 class="subtitle is-5 is-muted"></h5><div class=divider></div><section class="section content has-text-justified"><h2 id=table-of-contents>Table of Contents</h2><ul><li><a href=#introduction>Introduction</a></li><li><a href=#assumptions-and-prerequisites>Assumptions and Prerequisites</a></li><li><a href=#creating-our-certificate-request>Creating our Certificate Request</a><ul><li><a href=#including-our-requirements>Including our Requirements</a></li><li><a href=#generating-the-key-pair>Generating the Key Pair</a></li><li><a href=#generate-the-request>Generate the Request</a></li><li><a href=#sign-our-request>Sign our Request</a></li></ul></li><li><a href=#code-for-this-example>Code for this Example</a></li><li><a href=#real-world-example>Real World Example</a></li></ul><h1 id=introduction>Introduction</h1><p>After <a href=http://heartbleed.com/>Heartbleed</a>, I found myself in need of replacing
a large number of SSL keypairs, most of which included SAN certificates. Of
course, the first thing I did was try to script the process which resulted in
some bashing of my head against my desk as I stumbled through the OpenSSL Ruby
library.</p><p>But fret not, I&rsquo;ll try to explain it as best I can and if you think I&rsquo;ve made a
mistake, I&rsquo;m sure you will let me know in the comments below!</p><h1 id=assumptions-and-prerequisites>Assumptions and Prerequisites</h1><p>I assume you are using a modern Ruby, version 2.1 or greater in this case.
Though older versions may work, I have not tested any out. Let me know in the
comments if you find another one works or doesn&rsquo;t.</p><p>As for any gems we may need, the only one we pull in is the <code>openssl-extensions</code>
gem.</p><h1 id=creating-our-certificate-request>Creating our Certificate Request</h1><h2 id=including-our-requirements>Including our Requirements</h2><p>I may be in the minority, but I hate when I do not get the require statements I
need as part of the post. Since this is my article I will do future me a favor
and provide them here. You&rsquo;re welcome future me.</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-ruby">require &#39;openssl&#39;
require &#39;openssl-extensions/all&#39;</code></pre></div></div><h2 id=generating-the-key-pair>Generating the Key Pair</h2><p>Now we will generate our key pair. As you probably know, we need to provide the
public key as part of our request then use the private key to sign the request.</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-ruby">key = OpenSSL::PKey::RSA.new 2048

keyfile = &#39;/tmp/mycert.key&#39;
file = File.new(keyfile,&#39;w&#39;,0400)
file.write(key)
file.close</code></pre></div></div><h2 id=generate-the-request>Generate the Request</h2><p>Next up we will generate our request object. To do that, we first need to create
our certificate subject as an <code>OpenSSL::X509::Name</code> object:</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-ruby">subj_arr = [ [&#39;CN&#39;, &#39;myhost.example.com&#39;], [ &#39;DC&#39;,&#39;example&#39;], [&#39;DC&#39;,&#39;com&#39;]]
subj      = OpenSSL::X509::Name.new(subj_arr)</code></pre></div></div><p>Now, we create our request:</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-ruby">request = OpenSSL::X509::Request.new
request.version = 0
request.subject = subj
request.public_key = key.public_key</code></pre></div></div><p>Now that we have our request, we need to setup our extensions and add them to
it. This is the critical piece of this post since our SAN values are one of the
extensions we need to add.</p><p>To begin, I found the following to be needed for basic SSL certificates. You may
find different for your needs.</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-ruby">exts = [
  [ &#39;basicConstraints&#39;, &#39;CA:FALSE&#39;, false ],
  [ &#39;keyUsage&#39;, &#39;Digital Signature, Non Repudiation, Key Encipherment&#39;, false ],
]</code></pre></div></div><p>Next we add our SAN extension to the request. First we need to format each
SAN entry, then we&rsquo;ll add them to our extension array:</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-ruby">sans = [ &#39;example.com&#39;, &#39;www.example.com&#39; ]
sans.map! do |san|
  san = &#34;DNS:#{san}&#34;
end
exts &lt;&lt; [ &#39;subjectAltName&#39;, sans.join(&#39;,&#39;), false ]</code></pre></div></div><p>Now we need to convert our array into OpenSSL attributes, and add them to
our request.</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-ruby">ef = OpenSSL::X509::ExtensionFactory
exts.map! do |ext|
  ef.create_extension(*ext)
end
attrval = OpenSSL::ASN1::Set([OpenSSL::ASN1::Sequence(exts)])
attrs = [
  OpenSSL::X509::Attribute.new(&#39;extReq&#39;,attrval),
  OpenSSL::X509::Attribute.new(&#39;msExtReq&#39;,attrval),
]
attrs.each do |attr|
  request.add_attribute(attr)
end</code></pre></div></div><h2 id=sign-our-request>Sign our Request</h2><p>Finally, the very last thing we do is sign our request after we are done
modifying it. If you do any other work on the request object in your own code,
you need to make sure you do it before you get here.</p><div class="columns is-centered container"><div class="column is-full nonumbers"><pre><code class="code-highlight language-ruby">request.sign(key, OpenSSL::Digest::SHA1.new)

# save our request to a file
csrfile = &#39;/tmp/csrfile&#39;
file = File.new(csrfile,&#39;w&#39;,0400)
file.write(request)
file.close

# print out our request to screen for good measure
puts request.to_text</code></pre></div></div><h1 id=code-for-this-example>Code for this Example</h1><script type=application/javascript src=https://gist.github.com/arusso/d5a3195773c2ca3717d4.js></script><h1 id=real-world-example>Real World Example</h1><p>Remember how I needed to write a tool in the face of the Heartbleed scramble?
Well you can check out how I used the above code to write a tool that grabs an
existing certificate and extract the information I need to generate a new
key/certificate request based on it.</p><p>link: <a href=https://github.com/arusso/cert-tools/blob/master/regenerate-cert.rb>regenerate-cert</a></p></section></div></div></div><div class=container><div class=columns><div class="column has-text-right is-family-monospace is-centered-tablet-portrait">Last modified:&nbsp;29 March 2015</div></div></div></section><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//brainctl.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div id=backtotop><a href=#></a></div><div class="sidebar scroll"><div class=sidebar-header><img src=/sidebar.svg alt>
<a class=sidebar-close href=javascript:void(0);><i data-feather=x></i></a></div><div class=inner><ul class=sidebar-menu><li class=no-children><a href=/tags/><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cubes"></i></span>
All Tags</td><td class=has-text-right></td></tr></table></div></a><li class=no-children><a href=/tags/networking><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>networking</td><td class=has-text-right><div class=tag-number>2</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/puppet><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>puppet</td><td class=has-text-right><div class=tag-number>2</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ruby><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ruby</td><td class=has-text-right><div class=tag-number>2</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/bash><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>bash</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/certificate><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>certificate</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ci><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ci</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/cni><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>cni</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ex2300><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ex2300</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ex3400><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ex3400</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ipv6><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ipv6</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/juniper><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>Juniper</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/junos><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>JunOS</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/nmcli><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>nmcli</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/openssl><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>openssl</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/podman><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>podman</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/rbenv><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>rbenv</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/rfc4941><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>rfc4941</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/rfc7217><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>rfc7217</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/rvm><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>rvm</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/san><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>san</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/ssl/tls><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>ssl/tls</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li><li class=no-children><a href=/tags/testing><div class=columns><table width=100%><tr><td><span class=icon><i class="fa fa-cube"></i></span>testing</td><td class=has-text-right><div class=tag-number>1</div></td></tr></table></div></a></li></ul></div></div><script src=/js/jquery-2.2.4.893e90f6230962e42231635df650f20544ad22affc3ee396df768eaa6bc5a6a2.js integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI="></script>
<script src=/js/feather.4.22.0.1ab07abeb9975f283f6b5f29451981be680fbf77ea778f991d457511d210476a.js integrity="sha256-GrB6vrmXXyg/a18pRRmBvmgPv3fqd4+ZHUV1EdIQR2o="></script>
<script src=/js/modernizr-3.6.0.e013a1e54e3c19d83537ba42b900d34451e5e4b2e789be27a02ac9b152edb741.js integrity="sha256-4BOh5U48Gdg1N7pCuQDTRFHl5LLnib4noCrJsVLtt0E="></script>
<script src=/js/refresh.62c1a9b7d85bcf4d944cd585a01dfa8fb15112a7d2cf9fb819db20493bfe7484.js integrity="sha256-YsGpt9hbz02UTNWFoB36j7FREqfSz5+4GdsgSTv+dIQ="></script><script>window.MathJax={loader:{load:['core','input/tex-base','output/chtml'],source:{core:'/js/mathjax/core.d48fedf25c74c54fa6bf79646de92b02155872bdc4f5f7d0bbfc662523d8b4f5.js','input/tex-base':'/js/mathjax/tex-base.1b68b8741dfc54e8f7222f88bea8ffcfc57ac54b2a2d8f4edf6800aa44d49441.js','output/chtml':'/js/mathjax/chtml.926cd166e0f8c1f8a566a718d60c9c58a2b7142b156d30d5f02cec7c3b0ad60a.js','output/chtml/fonts/tex':'/js/mathjax/tex_out.b8b2bb939c0dae84bf1390bfe6d32af13e83f647cdac01d544d2a7a517477e9d.js'}},chtml:{fontURL:'/fonts'}}</script><script src=/js/mathjax/startup.234a2513e6bdbc1eee06ca19abceca30fe4034e82afb373c08274c1ba2feb1a6.js integrity="sha256-I0olE+a9vB7uBsoZq87KMP5ANOgq+zc8CCdMG6L+saY="></script>
<script src=/js/highlight.9.18.1.b1c58829c55afcc1f568022af4b08ed8976da404d2990b7535bd8e19c0e3310c.js integrity="sha256-scWIKcVa/MH1aAIq9LCO2JdtpATSmQt1Nb2OGcDjMQw="></script>
<script src=/js/highlightjs-line-numbers.2.7.0.min.ddfe282e07b7ec1ed069c23f92c7c8216ddb3f1879c4e962d37fd52adbd15a05.js integrity="sha256-3f4oLge37B7QacI/ksfIIW3bPxh5xOli03/VKtvRWgU="></script><script>hljs.initHighlightingOnLoad(),hljs.initLineNumbersOnLoad(),document.addEventListener('DOMContentLoaded',e=>{document.querySelectorAll('.codeinline').forEach(e=>{hljs.highlightBlock(e)})})</script></body></html>